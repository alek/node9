<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Video MIDI Mixer — Modern Edition</title>

  <!-- IBM Plex Sans & Mono -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0d10;
      --panel:#12161b;
      --panel-2:#151a21;
      --ink:#e6ebef;
      --muted:#9aa4af;
      --line:#1e252c;
      --accent:#6ea8ff;
      --accent-2:#7bdcb5;
      --danger:#ff6b6b;
      --radius:12px;
      --shadow:0 14px 36px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:"IBM Plex Sans",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;
      background:
        radial-gradient(1100px 600px at 20% -10%, #10151b 0%, var(--bg) 60%),
        radial-gradient(900px 600px at 120% 10%, #0f1420 0%, transparent 60%) var(--bg);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow-x:hidden;
    }
    .container{max-width:1600px;margin:0 auto;padding:20px}

    header{
      text-align:center;margin-bottom:30px;padding:20px;
      background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));
      border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);
    }
    h1{font-size:28px;font-weight:600;letter-spacing:.3px;text-shadow:none}
    #midi-status{margin-top:10px;font-size:13px;color:var(--muted)}
    #connect-midi{
      width:auto;padding:12px 18px;font-size:14px;font-weight:600;
      border:1px solid #2b3b52;border-radius:10px;cursor:pointer;
      color:#d8e7ff;background:linear-gradient(180deg,#243349,#19263a);
      box-shadow:0 1px 0 rgba(255,255,255,.03) inset,0 6px 18px rgba(0,0,0,.25);
      transition:transform .08s ease,border-color .2s ease,box-shadow .2s ease;
      font-family:"IBM Plex Sans",sans-serif;
    }
    #connect-midi:hover{border-color:#334964;transform:translateY(-1px)}
    #active-channel-display{
      margin-top:15px;padding:14px;background:var(--panel);
      border-radius:10px;font-size:16px;border:1px solid var(--line);text-align:left;
    }
    #active-channel-display kbd{
      font-family:"IBM Plex Mono",ui-monospace,Menlo,Consolas,monospace;
      background:#131a22;border:1px solid #223041;border-bottom-color:#1a2636;color:#c8d4e0;
      padding:2px 8px;border-radius:6px;font-size:11px;
      box-shadow:0 1px 0 rgba(0,0,0,.4),0 1px 0 rgba(255,255,255,.03) inset;
    }
    #midi-target{color:var(--accent-2);font-weight:600}

    .output-section{
      margin-bottom:30px;background:var(--panel);padding:16px;
      border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid var(--line);
    }
    #output-canvas{
      width:100%;max-width:900px;height:506px;background:#000;display:block;margin:0 auto;
      border:1px solid #0e141b;border-radius:10px;
    }

    .mixer-section{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
      gap:20px;margin-bottom:30px;
    }
    .channel{
      background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));
      padding:20px;border-radius:var(--radius);border:1px solid var(--line);
      transition:border-color .2s ease,box-shadow .2s ease;
      max-height:800px;overflow-y:auto;
    }
    .channel:hover{border-color:#2b3642;box-shadow:0 18px 40px rgba(0,0,0,.35)}
    .channel-header{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:15px;padding-bottom:10px;border-bottom:1px dashed var(--line)
    }
    .channel-title{font-size:15px;font-weight:600;color:var(--ink)}
    .channel-active{width:10px;height:10px;border-radius:50%;background:#2a3440;transition:background .2s ease}
    .channel.active .channel-active{background:var(--accent-2)}
    .channel::-webkit-scrollbar{width:8px}
    .channel::-webkit-scrollbar-track{background:#0f1216;border-radius:4px}
    .channel::-webkit-scrollbar-thumb{background:#2b3642;border-radius:4px}

    .video-input{margin-bottom:15px}
    .video-input label{display:block;margin-bottom:6px;color:var(--muted);font-size:12px}
    input[type="file"]{
      width:100%;padding:10px 12px;background:var(--panel-2);border:1px solid var(--line);
      border-radius:10px;color:var(--ink);cursor:pointer;font-size:13px;
      font-family:"IBM Plex Sans",sans-serif;
    }
    input[type="file"]::file-selector-button{
      background:#0f1319;color:#d2dbe6;border:1px solid #263141;padding:8px 12px;margin-right:10px;
      border-radius:8px;font-weight:600;font-size:12px;cursor:pointer;transition:border-color .2s ease,transform .08s ease;
    }
    input[type="file"]::file-selector-button:hover{border-color:#314055;transform:translateY(-1px)}
    .file-info{margin-top:6px;font-size:12px;color:var(--muted)}
    .preview-canvas{width:100%;height:100px;background:#000;margin-top:10px;border-radius:8px;outline:1px solid #0f141b}

    .section-title{
      color:var(--muted);font-size:12px;margin:15px 0 10px;padding-bottom:5px;
      border-bottom:1px solid var(--line);font-weight:600;letter-spacing:.16em;text-transform:uppercase;
    }
    .control-group{margin-bottom:12px}
    .control-label{display:flex;justify-content:space-between;margin-bottom:6px;color:var(--muted);font-size:12px}
    .control-value{color:var(--ink);font-weight:600;font-size:12px}

    input[type="range"]{
      width:100%;height:28px;background:transparent;appearance:none;
    }
    input[type="range"]::-webkit-slider-runnable-track{
      height:4px;background:#1a2230;border-radius:999px;border:1px solid #222c3a;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;width:16px;height:16px;border-radius:50%;
      background:linear-gradient(180deg,#b9d4ff,#6ea8ff);border:0;margin-top:-6px;
      box-shadow:0 2px 10px rgba(110,168,255,.45);
    }

    select{
      width:100%;padding:10px 12px;background:var(--panel-2);border:1px solid var(--line);
      border-radius:10px;color:var(--ink);font-family:"IBM Plex Sans",sans-serif;font-size:13px;cursor:pointer;
    }

    .checkbox-group{display:flex;align-items:center;gap:8px;margin-bottom:10px}
    input[type="checkbox"]{width:16px;height:16px;cursor:pointer}
    .checkbox-group label{color:var(--muted);font-size:13px;cursor:pointer}

    .master-controls{
      background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));
      padding:20px;border-radius:var(--radius);border:1px solid var(--line);box-shadow:var(--shadow);
    }
    .master-controls h2{margin:0 0 16px;color:var(--ink);text-align:center;font-size:16px;font-weight:600}
    .master-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}

    button{
      width:100%;padding:11px 12px;background:linear-gradient(180deg,var(--panel-2),#10161d);
      color:var(--ink);border:1px solid var(--line);border-radius:10px;cursor:pointer;
      font-size:14px;font-weight:600;margin-top:5px;font-family:"IBM Plex Sans",sans-serif;
      box-shadow:0 1px 0 rgba(255,255,255,.03) inset,0 6px 18px rgba(0,0,0,.25);
      transition:transform .08s ease,border-color .2s ease,box-shadow .2s ease,background .2s ease;
    }
    button:hover{border-color:#2b3642;transform:translateY(-1px);box-shadow:0 2px 0 rgba(255,255,255,.03) inset,0 10px 26px rgba(0,0,0,.35)}
    button:active{transform:translateY(0)}
    button:focus{outline:2px solid var(--accent);outline-offset:2px}
    .btn-danger{border-color:#3b1e25;background:linear-gradient(180deg,#2a1216,#1a0c0e);color:#ffd6d6}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Video MIDI Mixer</h1>
      <div style="margin-top: 15px;">
        <button id="connect-midi">Connect MIDI Device</button>
        <div id="midi-status">No MIDI device connected</div>
        <div id="active-channel-display">
          <strong>MIDI Controls:</strong>
          <span id="midi-target">CHANNEL 1</span>
          <div style="font-size:12px;margin-top:8px;color:var(--muted);">
            Press <kbd>1</kbd>, <kbd>2</kbd>, or <kbd>3</kbd> to select channel &bull; Press <kbd>F</kbd> for fullscreen
          </div>
          <div style="font-size:12px;margin-top:10px;color:#ffaa00;border-top:1px solid var(--line);padding-top:10px;">
            Pitch Bend: Ch1 Opacity • Ch2 Loop Start • <b>Ch3 PixelSort X</b> • <b>Ch4 PixelSort Width</b> • Ch6 Hue • Ch7 Brightness • Ch8 Contrast
          </div>
        </div>
      </div>
    </header>

    <div class="output-section"><canvas id="output-canvas"></canvas></div>
    <div class="mixer-section" id="channels-container"></div>

    <div class="master-controls">
      <h2>Master Controls</h2>
      <div class="master-grid">
        <button id="play-all">Play All</button>
        <button id="pause-all">Pause All</button>
        <button id="reset-all" class="btn-danger">Reset All</button>
      </div>
    </div>
  </div>

  <script>
  'use strict';

  /* ===================== Canvas & Channels ===================== */
  var canvas = document.getElementById('output-canvas');
  var ctx = canvas.getContext('2d');
  canvas.width = 1280; canvas.height = 720;

  var channels = {
    1: { active:false, video:null, isImage:false, controls:{} },
    2: { active:false, video:null, isImage:false, controls:{} },
    3: { active:false, video:null, isImage:false, controls:{} }
  };

  var midiAccess = null, midiInput = null, activeChannel = 1, isFullscreen = false;

  /* ===================== UI: Keyboard & Fullscreen ===================== */
  document.addEventListener('keydown', function(e){
    if (e.key === '1') { activeChannel = 1; updateActiveChannelDisplay(); }
    else if (e.key === '2') { activeChannel = 2; updateActiveChannelDisplay(); }
    else if (e.key === '3') { activeChannel = 3; updateActiveChannelDisplay(); }
    else if (e.key === 'f' || e.key === 'F') { toggleFullscreen(); }
    else if (e.key === 'Escape' && isFullscreen) { toggleFullscreen(); }
  });

  function toggleFullscreen(){
    var header = document.querySelector('header');
    var mixerSection = document.querySelector('.mixer-section');
    var masterControls = document.querySelector('.master-controls');
    var outputSection = document.querySelector('.output-section');
    isFullscreen = !isFullscreen;
    if (isFullscreen) {
      document.body.style.overflow = 'hidden';
      header.style.display = 'none';
      mixerSection.style.display = 'none';
      masterControls.style.display = 'none';
      outputSection.style.position = 'fixed';
      outputSection.style.top = '0';
      outputSection.style.left = '0';
      outputSection.style.width = '100vw';
      outputSection.style.height = '100vh';
      outputSection.style.margin = '0';
      outputSection.style.padding = '0';
      outputSection.style.background = '#000';
      outputSection.style.borderRadius = '0';
      outputSection.style.zIndex = '9999';
      outputSection.style.display = 'flex';
      outputSection.style.alignItems = 'center';
      outputSection.style.justifyContent = 'center';
      canvas.style.maxWidth = '100%';
      canvas.style.maxHeight = '100%';
      canvas.style.width = 'auto';
      canvas.style.height = 'auto';
      canvas.style.border = 'none';
    } else {
      document.body.style.overflow = '';
      header.style.display = '';
      mixerSection.style.display = '';
      masterControls.style.display = '';
      outputSection.style.cssText = '';
      canvas.style.cssText = '';
    }
  }

  function updateActiveChannelDisplay(){
    var display = document.getElementById('midi-target');
    var colors = { 1:'var(--accent-2)', 2:'var(--accent)', 3:'#ff9bff' };
    display.textContent = 'CHANNEL ' + activeChannel;
    display.style.color = colors[activeChannel];

    var channelEl = document.getElementById('channel' + activeChannel);
    if (channelEl) {
      channelEl.style.borderColor = '#2b3642';
      channelEl.style.boxShadow = '0 18px 40px rgba(0,0,0,.35)';
      setTimeout(function(){ channelEl.style.borderColor=''; channelEl.style.boxShadow=''; }, 480);
    }
  }

  /* ===================== MIDI: Connect ===================== */
  document.getElementById('connect-midi').addEventListener('click', function(){
    if (!navigator.requestMIDIAccess) {
      setMIDIStatus('Web MIDI not supported', '#ff9b9b'); return;
    }
    navigator.requestMIDIAccess({ sysex:false }).then(function(access){
      midiAccess = access;
      var inputs = Array.from(midiAccess.inputs.values());
      if (inputs.length === 0) { setMIDIStatus('No MIDI devices found', '#ff9b9b'); return; }
      midiInput = inputs[0];
      midiInput.onmidimessage = handleMIDIMessage;
      setMIDIStatus('Connected: ' + midiInput.name, '#7bdcb5');
    }).catch(function(err){
      setMIDIStatus('Error: ' + err.message, '#ff9b9b');
    });
  });

  function setMIDIStatus(text, color){
    var el = document.getElementById('midi-status');
    el.textContent = text; el.style.color = color;
  }

  /* ===================== MIDI: CC map (from your capture: CC16..23) ===================== */
  var CC_MAP = {
    16: { control:'opacity',    min:0,   max:100 },
    17: { control:'scale',      min:10,  max:300 },
    18: { control:'posX',       min:-500,max:500 },
    19: { control:'posY',       min:-500,max:500 },
    20: { control:'rotate',     min:0,   max:360 },
    21: { control:'hue',        min:0,   max:360 },
    22: { control:'brightness', min:0,   max:300 },
    23: { control:'contrast',   min:0,   max:300 }
  };

  /* ===================== MIDI: Notes (from your capture: 46,47,91..99) ===================== */
  var NOTE_ACTIONS = {
    91: function(){ activeChannel = 1; updateActiveChannelDisplay(); },
    92: function(){ activeChannel = 2; updateActiveChannelDisplay(); },
    93: function(){ activeChannel = 3; updateActiveChannelDisplay(); },
    94: function(){ togglePlayPause(activeChannel); },
    95: function(){ resetSource(activeChannel); },
    96: function(){ toggleFlag(activeChannel, 'flipH'); },
    97: function(){ toggleFlag(activeChannel, 'flipV'); },
    98: function(){ cycleBlend(activeChannel); },
    99: function(){ toggleActive(activeChannel); }
  };

  /* ===================== MIDI: Message Handler ===================== */
  function handleMIDIMessage(event){
    var status = event.data[0], data1 = event.data[1], data2 = event.data[2];
    var messageType = status & 0xF0;
    var midiChan = (status & 0x0F) + 1; // 1..16

    if (messageType === 0xB0) { // CC
      var cc = data1, val7 = data2; // 0..127
      if (CC_MAP[cc]) applyCCToControls(CC_MAP[cc], val7);
      return;
    }

    if (messageType === 0x90) { // Note On (vel>0)
      var note = data1, vel = data2;
      if (vel === 0) { handleNoteOff(note); return; }
      handleNoteOn(note); return;
    }

    if (messageType === 0x80) { // Note Off
      handleNoteOff(data1); return;
    }

    if (messageType === 0xE0) { // Pitch Bend
      var bend14 = (data2 << 7) | data1; // 0..16383
      applyPitchBend(midiChan, bend14); return;
    }
  }

  function applyCCToControls(map, val7){
    var ch = channels[activeChannel]; if (!ch) return;
    var normalized = val7 / 127;
    var mapped = map.min + normalized * (map.max - map.min);
    var controlId = map.control + String(activeChannel);
    var slider = document.getElementById(controlId);
    if (slider) { slider.value = mapped; slider.dispatchEvent(new Event('input')); }
    else { ch.controls[map.control] = mapped; }
  }

  function handleNoteOn(note){ if (NOTE_ACTIONS[note]) NOTE_ACTIONS[note](); }
  function handleNoteOff(note){}

  function togglePlayPause(n){
    var ch = channels[n]; if (!ch || !ch.video || ch.isImage) return;
    if (ch.video.paused) ch.video.play(); else ch.video.pause();
  }
  function resetSource(n){
    var ch = channels[n]; if (!ch || !ch.video || ch.isImage) return;
    ch.video.currentTime = 0;
  }
  function toggleFlag(n, flag){
    var ch = channels[n]; if (!ch) return;
    ch.controls[flag] = !ch.controls[flag];
    var id = (flag === 'flipH' ? 'flipH' : 'flipV') + String(n);
    var cb = document.getElementById(id);
    if (cb) cb.checked = !!ch.controls[flag];
  }
  function cycleBlend(n){
    var ch = channels[n]; if (!ch) return;
    var modes = ['source-over','screen','multiply','overlay','difference'];
    var cur = ch.controls.blend || 'source-over';
    var idx = 0, i; for(i=0;i<modes.length;i++){ if(modes[i]===cur){ idx=i; break; } }
    var next = modes[(idx+1)%modes.length];
    ch.controls.blend = next;
    var sel = document.getElementById('blend'+String(n));
    if (sel) sel.value = next;
  }
  function toggleActive(n){
    channels[n].active = !channels[n].active;
    updateChannelStatus(n);
  }

  /* ===================== Pitch Bend mapping (updated: 3–4 for PixelSort) ===================== */
  function applyPitchBend(midiChan, bend14){
    var ch = channels[activeChannel]; if (!ch) return;
    var norm = bend14 / 16383; // 0..1

    if (midiChan === 1) {
      var o = norm * 100;
      var s1 = document.getElementById('opacity' + String(activeChannel));
      if (s1) { s1.value = o; s1.dispatchEvent(new Event('input')); }
    } else if (midiChan === 2 && ch.video && !ch.isImage) {
      ch.controls.loopStart = norm * ch.video.duration;
    } else if (midiChan === 3) {
      ch.controls.pixelSortStart = Math.floor(norm * canvas.width);
    } else if (midiChan === 4) {
      ch.controls.pixelSortWidth = Math.floor(norm * canvas.width);
    } else if (midiChan === 6) {
      var h = Math.floor(norm * 360);
      var hEl = document.getElementById('hue' + String(activeChannel));
      if (hEl) { hEl.value = h; hEl.dispatchEvent(new Event('input')); }
    } else if (midiChan === 7) {
      var b = Math.floor(norm * 300);
      var bEl = document.getElementById('brightness' + String(activeChannel));
      if (bEl) { bEl.value = b; bEl.dispatchEvent(new Event('input')); }
    } else if (midiChan === 8) {
      var c = Math.floor(norm * 300);
      var cEl = document.getElementById('contrast' + String(activeChannel));
      if (cEl) { cEl.value = c; cEl.dispatchEvent(new Event('input')); }
    }
  }

  /* ===================== Channels UI & Loading ===================== */
  function createChannelHTML(num){
    var html = '';
    html += '<div class="channel" id="channel' + num + '">';
    html +=   '<div class="channel-header"><span class="channel-title">CHANNEL ' + num + '</span><div class="channel-active"></div></div>';
    html +=   '<div class="video-input"><label>Load Video or Image</label>';
    html +=     '<input type="file" accept="video/*,image/*" id="video' + num + '-input">';
    html +=     '<div class="file-info" id="info' + num + '"></div>';
    html +=     '<canvas class="preview-canvas" id="preview' + num + '"></canvas>';
    html +=   '</div>';

    html +=   '<div class="section-title">BASIC CONTROLS</div>';
    html +=   controlBlock('opacity',  num, '100%', 0,   100, 100);
    html +=   controlBlock('scale',    num, '1.0x', 10,  300, 100);
    html +=   controlBlock('posX',     num, '0',   -500, 500, 0);
    html +=   controlBlock('posY',     num, '0',   -500, 500, 0);
    html +=   controlBlock('rotate',   num, '0°',    0,  360, 0);

    html +=   '<div class="control-group"><label class="control-label">Blend Mode</label><select id="blend' + num + '">';
    html +=     '<option value="source-over">Normal</option><option value="screen">Screen</option><option value="multiply">Multiply</option><option value="overlay">Overlay</option><option value="difference">Difference</option>';
    html +=   '</select></div>';

    html +=   '<div class="section-title">COLOR EFFECTS</div>';
    html +=   controlBlock('hue',       num, '0°',   0, 360, 0);
    html +=   controlBlock('brightness',num, '100%', 0, 300, 100);
    html +=   controlBlock('contrast',  num, '100%', 0, 300, 100);
    html +=   controlBlock('saturate',  num, '100%', 0, 300, 100);
    html +=   controlBlock('blur',      num, '0px',  0,  50, 0);

    html +=   '<div class="checkbox-group"><input type="checkbox" id="flipH' + num + '"><label for="flipH' + num + '">Flip Horizontal</label></div>';
    html +=   '<div class="checkbox-group"><input type="checkbox" id="flipV' + num + '"><label for="flipV' + num + '">Flip Vertical</label></div>';

    html +=   '<button id="toggle' + num + '">TOGGLE ON/OFF</button>';
    html += '</div>';
    return html;
  }

  function controlBlock(name, num, labelRight, min, max, value){
    var id = name + String(num);
    var valId = id + '-val';
    var block = '';
    block += '<div class="control-group">';
    block +=   '<div class="control-label"><span>' + niceLabel(name) + '</span><span class="control-value" id="' + valId + '">' + labelRight + '</span></div>';
    block +=   '<input type="range" id="' + id + '" min="' + String(min) + '" max="' + String(max) + '" value="' + String(value) + '">';
    block += '</div>';
    return block;
  }

  function niceLabel(name){
    var m = { opacity:'Opacity', scale:'Scale', posX:'Position X', posY:'Position Y', rotate:'Rotation',
              hue:'Hue', brightness:'Brightness', contrast:'Contrast', saturate:'Saturation', blur:'Blur' };
    return m[name] || name;
  }

  var container = document.getElementById('channels-container');
  var i; for (i=1;i<=3;i++) container.innerHTML += createChannelHTML(i);

  for (i=1;i<=3;i++){
    (function(n){
      var input = document.getElementById('video'+n+'-input');
      var preview = document.getElementById('preview'+n);
      var info = document.getElementById('info'+n);
      var previewCtx = preview.getContext('2d');
      preview.width = preview.offsetWidth; preview.height = 100;

      input.addEventListener('change', function(e){
        var file = e.target.files[0]; if (!file) return;
        channels[n].active = false;
        var url = URL.createObjectURL(file);
        if (file.type.indexOf('video') === 0) {
          loadVideoToChannel(url, file, n, info, previewCtx, preview);
        } else if (file.type.indexOf('image') === 0) {
          loadImageToChannel(url, file, n, info, previewCtx, preview);
        } else {
          info.textContent = 'Unsupported file type.';
        }
      });

      initializeControls(n);
      document.getElementById('toggle'+n).addEventListener('click', function(){
        channels[n].active = !channels[n].active;
        updateChannelStatus(n);
      });
    })(i);
  }

  function loadVideoToChannel(url, file, n, info, previewCtx, preview){
    info.textContent = 'Loading video: ' + file.name + ' ...';
    var video = document.createElement('video');
    video.muted = true; video.loop = true; video.playsInline = true; video.crossOrigin = 'anonymous';
    video.src = url;
    video.onloadedmetadata = function(){
      channels[n].video = video; channels[n].isImage = false; channels[n].active = true;
      info.textContent = '✓ ' + file.name + ' (' + Math.round(video.duration) + 's, ' + video.videoWidth + '×' + video.videoHeight + ')';
      video.play().then(function(){
        updateChannelStatus(n);
        function drawPreview(){
          if (channels[n].video !== video) return;
          if (video.readyState >= 2) previewCtx.drawImage(video, 0, 0, preview.width, preview.height);
          requestAnimationFrame(drawPreview);
        }
        drawPreview();
      }).catch(function(){});
    };
    video.onerror = function(){ info.textContent = 'Failed to load video.'; };
    video.load();
  }

  function loadImageToChannel(url, file, n, info, previewCtx, preview){
    info.textContent = 'Loading image: ' + file.name + ' ...';
    var img = new Image();
    img.crossOrigin = 'anonymous';
    img.src = url;
    img.onload = function(){
      channels[n].video = img; channels[n].isImage = true; channels[n].active = true;
      info.textContent = '✓ ' + file.name + ' (image ' + img.naturalWidth + '×' + img.naturalHeight + ')';
      updateChannelStatus(n);

      previewCtx.clearRect(0,0,preview.width,preview.height);
      var s = Math.min(preview.width/img.naturalWidth, preview.height/img.naturalHeight);
      var w = img.naturalWidth*s, h = img.naturalHeight*s;
      var x = (preview.width - w)/2, y = (preview.height - h)/2;
      previewCtx.drawImage(img, x, y, w, h);
    };
    img.onerror = function(){ info.textContent = 'Failed to load image.'; };
  }

  function initializeControls(n){
    var c = channels[n].controls;
    function addControl(name, def, cb){
      var el = document.getElementById(name + String(n));
      var val = document.getElementById(name + String(n) + '-val');
      el.addEventListener('input', function(e){
        c[name] = cb(e.target.value);
        if (val) val.textContent = cb(e.target.value, true);
      });
      c[name] = def;
    }
    addControl('opacity',   1,   function(v, d){ return d ? (v + '%') : (v/100); });
    addControl('scale',     1,   function(v, d){ return d ? ((v/100).toFixed(1) + 'x') : (v/100); });
    addControl('posX',      0,   function(v, d){ return d ? v : parseInt(v,10); });
    addControl('posY',      0,   function(v, d){ return d ? v : parseInt(v,10); });
    addControl('rotate',    0,   function(v, d){ return d ? (v + '°') : parseInt(v,10); });
    addControl('hue',       0,   function(v, d){ return d ? (v + '°') : v; });
    addControl('brightness',100, function(v, d){ return d ? (v + '%') : v; });
    addControl('contrast',  100, function(v, d){ return d ? (v + '%') : v; });
    addControl('saturate',  100, function(v, d){ return d ? (v + '%') : v; });
    addControl('blur',      0,   function(v, d){ return d ? (v + 'px') : v; });

    document.getElementById('blend' + n).addEventListener('change', function(e){ c.blend = e.target.value; });
    document.getElementById('flipH' + n).addEventListener('change', function(e){ c.flipH = e.target.checked; });
    document.getElementById('flipV' + n).addEventListener('change', function(e){ c.flipV = e.target.checked; });

    c.blend = 'source-over'; c.flipH = false; c.flipV = false;
    c.loopStart = 0; c.loopEnd = 0;
    c.pixelSortStart = 0; c.pixelSortWidth = 0;
  }

  function updateChannelStatus(n){
    var el = document.getElementById('channel' + n);
    if (channels[n].active) el.classList.add('active'); else el.classList.remove('active');
  }

  /* ===================== Master transport ===================== */
  document.getElementById('play-all').addEventListener('click', function(){
    var i; for (i=1;i<=3;i++){ var ch = channels[i];
      if (ch.video && !ch.isImage && typeof ch.video.play === 'function') ch.video.play();
    }
  });
  document.getElementById('pause-all').addEventListener('click', function(){
    var i; for (i=1;i<=3;i++){ var ch = channels[i];
      if (ch.video && !ch.isImage && typeof ch.video.pause === 'function') ch.video.pause();
    }
  });
  document.getElementById('reset-all').addEventListener('click', function(){
    var i; for (i=1;i<=3;i++){ var ch = channels[i];
      if (ch.video && !ch.isImage) ch.video.currentTime = 0;
    }
  });

  /* ===================== FAST Pixel Sort (counting sort) ===================== */
  var SORT_THROTTLE_MS = 16; // ~60fps
  var _lastSortTS = 0;

  function applyPixelSortFast(startX, width){
    var now = performance.now();
    if (now - _lastSortTS < SORT_THROTTLE_MS) return;
    _lastSortTS = now;

    if (width <= 0) return;
    var x = Math.max(0, Math.min(canvas.width - 1, Math.floor(startX)));
    var w = Math.max(1, Math.min(canvas.width - x, Math.floor(width)));
    var h = canvas.height;

    var imageData = ctx.getImageData(x, 0, w, h);
    var data = imageData.data; // Uint8ClampedArray

    // Per-column counting sort by brightness (0..255)
    var col, row;
    // temp buffers reused per column
    var r = new Uint8ClampedArray(h);
    var g = new Uint8ClampedArray(h);
    var b = new Uint8ClampedArray(h);
    var a = new Uint8ClampedArray(h);
    var bright = new Uint8Array(h);
    var counts = new Uint16Array(256);
    var cum = new Uint16Array(256);

    for (col = 0; col < w; col++){
      // extract column and brightness
      var base = col * 4;
      for (row = 0; row < h; row++){
        var idx = (row * w * 4) + base;
        var R = data[idx], G = data[idx+1], B = data[idx+2], A = data[idx+3];
        r[row] = R; g[row] = G; b[row] = B; a[row] = A;
        // perceptual-ish brightness (simple average; fast)
        var br = (R + G + B) / 3;
        br = br & 255;
        bright[row] = br;
        counts[br]++;
      }
      // cumulative
      var sum = 0, k;
      for (k=0;k<256;k++){ var c = counts[k]; cum[k] = sum; sum += c; }
      // place into sorted order
      var outR = r.slice(0), outG = g.slice(0), outB = b.slice(0), outA = a.slice(0); // copy sources
      for (row = 0; row < h; row++){
        var br2 = bright[row];
        var pos = cum[br2]++;
        r[pos] = outR[row];
        g[pos] = outG[row];
        b[pos] = outB[row];
        a[pos] = outA[row];
      }
      // write back
      for (row = 0; row < h; row++){
        var idx2 = (row * w * 4) + base;
        data[idx2]   = r[row];
        data[idx2+1] = g[row];
        data[idx2+2] = b[row];
        data[idx2+3] = a[row];
      }
      // reset counts for next column
      counts.fill(0);
    }
    ctx.putImageData(imageData, x, 0);
  }

  /* ===================== Render loop ===================== */
  function render(){
    ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);

    var i;
    for (i=1;i<=3;i++){
      var ch = channels[i];
      if (!ch.active || !ch.video) continue;

      var ready = ch.isImage ? !!ch.video.complete : (ch.video.readyState >= 2);
      if (!ready) continue;

      var c = ch.controls;

      if (!ch.isImage && c.loopEnd > 0 && ch.video.currentTime >= c.loopEnd) {
        ch.video.currentTime = c.loopStart;
      }

      ctx.save();
      ctx.globalCompositeOperation = c.blend;
      ctx.globalAlpha = c.opacity;

      var centerX = canvas.width/2 + c.posX;
      var centerY = canvas.height/2 + c.posY;
      ctx.translate(centerX, centerY);
      ctx.rotate((c.rotate * Math.PI) / 180);
      if (c.flipH) ctx.scale(-1, 1);
      if (c.flipV) ctx.scale(1, -1);

      var w = canvas.width * c.scale;
      var h = canvas.height * c.scale;

      var filters = [];
      if (c.hue > 0)           filters.push('hue-rotate(' + c.hue + 'deg)');
      if (c.brightness != 100) filters.push('brightness(' + c.brightness + '%)');
      if (c.contrast != 100)   filters.push('contrast(' + c.contrast + '%)');
      if (c.saturate != 100)   filters.push('saturate(' + c.saturate + '%)');
      if (c.blur > 0)          filters.push('blur(' + c.blur + 'px)');
      ctx.filter = filters.length ? filters.join(' ') : 'none';

      ctx.drawImage(ch.video, -w/2, -h/2, w, h);
      ctx.restore();

      if (c.pixelSortWidth > 0) applyPixelSortFast(c.pixelSortStart, c.pixelSortWidth);
    }

    requestAnimationFrame(render);
  }

  render();
  </script>
</body>
</html>
